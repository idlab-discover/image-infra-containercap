name: Build and Push Container Images

on:
  push:
    branches:
      - "main"
    paths:
      - '**/Dockerfile'
      - '**/Makefile'
      - '.github/workflows/build-and-push.yml'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: 'true'
        fetch-depth: 0  # Fetch all history for git diff

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get list of changed files
      run: |
        echo "CHANGED_DIRS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep 'Makefile' | xargs -I {} dirname {} | sort | uniq)" >> $GITHUB_ENV
        
    - name: Build and push changed images
      run: |
        for dir in $CHANGED_DIRS; do
          if [ -f "$dir/Makefile" ]; then
            echo "Running make in $dir"
            (cd $dir && make build_push)
          fi
        done
      env:
        CHANGED_DIRS: ${{ env.CHANGED_DIRS }}
